#!/usr/bin/env python
import datetime, os
from subprocess import call
from threading import Thread
import sys

PROGRAMS = ['ILS_Shrink', 'Constructed_RRLS']

INSTANCES = """warmup, anchors, ranges, backrefs, abba, aman-aplan, prime, four, order,
               triples, glob, balance, powers, long-count, alphabetical""".split(',')

i = int(sys.argv[1]) if len(sys.argv) == 2 else 0

INSTANCES_TO_EXECUTE = [
    INSTANCES[:4],
    INSTANCES[4:8],
    INSTANCES[8:12],
    INSTANCES[12:],
]

SEEDS = [2967301147, 5600405384, 1632819610, 1412034944, 9724161943, 4037724866,
         8370032799, 2767986875, 3141506592, 3313543896, 8657690939, 9696640194,
         6621545651, 2492462788, 3404588599, 2330977742, 6361187489, 2805026820,
         4323456912, 8361101999, 9935136846, 5217407358, 5619256299, 4560422870,
         5236888092, 1337360711, 7659837985, 2521100877, 8801535107, 9651599436]

DEPTHS = [5]

FOLDER_NAME = 'neighborhood'


def execute(cmd):
    cmd = list(map(str, cmd))
    call(cmd, shell=os.name == 'nt')


for program in PROGRAMS:
    for instance in INSTANCES_TO_EXECUTE[i]:
        instance = instance.strip()
        for depth in DEPTHS:
            for index, seed in enumerate(SEEDS):
                today = datetime.date.today().strftime("%Y-%m-%d")
                resultsDir = FOLDER_NAME
                absResultsDir = "%s/results/%s" % (os.getcwd(), resultsDir)

                if not os.path.isdir(absResultsDir):
                    os.mkdir(absResultsDir)

                absCsvFilePath = "%s/%s.csv" % (absResultsDir, program)
                csvFilePath = "%s/%s.csv" % (resultsDir, program)

                if not os.path.isfile(absCsvFilePath):
                    call(['touch', absCsvFilePath])

                cmd = ["npm", "run", "localsearch", "--",
                       "--name", program,
                       "--instance", instance,
                       "--depth", depth,
                       "--index", index,
                       "--seed", seed,
                       "--log-level", 1,
                       "--csv", csvFilePath]

                thread = Thread(target=execute, args=(cmd,))
                thread.start()
                thread.join()

